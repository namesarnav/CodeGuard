name: Scan PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run CodeGuard scan
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          QDRANT_HOST: localhost
          QDRANT_PORT: 6333
        run: |
          python -m app.cli scan . --format json --output pr-scan-results.json

      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('pr-scan-results.json', 'utf8'));
            
            const critical = results.summary.by_severity.critical || 0;
            const high = results.summary.by_severity.high || 0;
            const medium = results.summary.by_severity.medium || 0;
            
            let comment = `## üîç CodeGuard AI Scan Results\n\n`;
            comment += `**Total Issues:** ${results.total_issues}\n`;
            comment += `- üî¥ Critical: ${critical}\n`;
            comment += `- üü† High: ${high}\n`;
            comment += `- üü° Medium: ${medium}\n\n`;
            
            if (critical > 0 || high > 0) {
              comment += `‚ö†Ô∏è **Action Required:** Critical or high severity issues found.\n\n`;
            }
            
            comment += `\n<details>\n<summary>View all issues</summary>\n\n`;
            
            results.issues.slice(0, 10).forEach(issue => {
              comment += `### ${issue.title}\n`;
              comment += `**Severity:** ${issue.severity}\n`;
              comment += `**Location:** ${issue.location.file_path}:${issue.location.start_line}\n`;
              comment += `\n`;
            });
            
            comment += `</details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

